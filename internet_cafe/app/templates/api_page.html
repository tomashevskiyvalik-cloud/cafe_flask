{% extends 'base.html' %}

{% block title %}API ‚Äî –ö–∞—Ñ–µ{% endblock %}

{% block content %}
<h1>üì° REST API</h1>

<p>–ù–∏–∂—á–µ –Ω–∞–≤–µ–¥–µ–Ω–æ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –æ—Å–Ω–æ–≤–Ω—ñ API endpoints. –ö–ª—ñ–∫–Ω—ñ—Ç—å, —â–æ–± –≤—ñ–¥–∫—Ä–∏—Ç–∏ JSON —É –Ω–æ–≤—ñ–π –≤–∫–ª–∞–¥—Ü—ñ.</p>

<div class="api-container">
    <a href="{{ url_for('api.get_tovars') }}" target="_blank" class="api-btn">üì¶ Tovars (GET)</a>
    <a href="{{ url_for('api.get_orders') }}" target="_blank" class="api-btn">üìë Orders (GET)</a>
    <a href="{{ url_for('api.get_feedbacks') }}" target="_blank" class="api-btn">üí¨ Feedbacks (GET)</a>
</div>

<p>–î–ª—è POST/PUT/DELETE –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ Postman –∞–±–æ curl.</p>

<hr>

<!-- ‚úÖ –õ–†6: —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è frontend + API (–º—ñ–Ω—ñ–º–∞–ª—å–Ω–æ, –Ω–µ –ª–∞–º–∞—î —Å—Ç–æ—Ä—ñ–Ω–∫—É) -->
<h2 style="margin-top:20px;">üß™ Demo (Lab 6): —Å–ø–∏—Å–æ–∫ + –¥–æ–¥–∞–≤–∞–Ω–Ω—è —Ç–æ–≤–∞—Ä—É</h2>

<div id="message" style="margin:10px 0;"></div>
<div id="loading" style="display:none; margin:10px 0;">‚è≥ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>

<form id="addForm" style="max-width:500px;">
    <label>–ù–∞–∑–≤–∞</label>
    <input id="nazva" type="text" required>

    <label>–û–ø–∏—Å</label>
    <input id="opis" type="text">

    <label>–¶—ñ–Ω–∞</label>
    <input id="tsina" type="number" required>

    <button type="submit" class="api-btn" style="margin-top:10px;">–î–æ–¥–∞—Ç–∏ —Ç–æ–≤–∞—Ä (POST)</button>
</form>

<div id="dataList" style="margin-top:15px;"></div>

<script>
const API_URL = '/api/tovars';

function showLoading(show) {
  document.getElementById('loading').style.display = show ? 'block' : 'none';
}

function showMessage(text, type) {
  const box = document.getElementById('message');
  box.textContent = text;
  box.style.color = (type === 'error') ? 'red' : 'green';
  setTimeout(() => { box.textContent = ''; }, 4000);
}

async function loadTovars() {
  try {
    showLoading(true);
    const res = await fetch(API_URL);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();

    const list = document.getElementById('dataList');
    list.innerHTML = '';

    if (!data || data.length === 0) {
      list.innerHTML = '<p>–¢–æ–≤–∞—Ä—ñ–≤ –ø–æ–∫–∏ –Ω–µ–º–∞—î.</p>';
      return;
    }

    data.forEach(t => {
      const div = document.createElement('div');
      div.style.border = '1px solid #ddd';
      div.style.padding = '10px';
      div.style.marginBottom = '8px';
      div.innerHTML = `
        <b>${t.nazva ?? ''}</b><br>
        <span>${t.opis ?? ''}</span><br>
        <span>üí∞ ${t.tsina ?? ''}</span>
      `;
      list.appendChild(div);
    });

  } catch (e) {
    showMessage('‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è: ' + e.message, 'error');
  } finally {
    showLoading(false);
  }
}

document.getElementById('addForm').addEventListener('submit', async (e) => {
  e.preventDefault();

  const nazva = document.getElementById('nazva').value.trim();
  const opis = document.getElementById('opis').value.trim();
  const tsina = Number(document.getElementById('tsina').value);

  if (nazva.length < 2) {
    showMessage('‚ùå –ù–∞–∑–≤–∞ –º–∞—î –±—É—Ç–∏ –º—ñ–Ω—ñ–º—É–º 2 —Å–∏–º–≤–æ–ª–∏', 'error');
    return;
  }

  try {
    showLoading(true);
    const res = await fetch(API_URL, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ nazva, opis, tsina })
    });

    if (!res.ok) {
      const txt = await res.text().catch(()=>'');
      throw new Error(`HTTP ${res.status} ${txt}`);
    }

    showMessage('‚úÖ –¢–æ–≤–∞—Ä –¥–æ–¥–∞–Ω–æ!', 'success');
    e.target.reset();
    await loadTovars();
  } catch (e) {
    showMessage('‚ùå –ü–æ–º–∏–ª–∫–∞ –¥–æ–¥–∞–≤–∞–Ω–Ω—è: ' + e.message, 'error');
  } finally {
    showLoading(false);
  }
});

window.addEventListener('load', loadTovars);
</script>

{% endblock %}